<!DOCTYPE html>
<html>
  <head>
    <!-- thanks to https://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="194x194" href="favicons/favicon-194x194.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png">
    <link rel="manifest" href="favicons/manifest.json">
    <link rel="mask-icon" href="favicons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    <!-- iOS / PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <link href="https://fonts.googleapis.com/css?family=Monoton|Press+Start+2P" rel="stylesheet">
    <link href="style.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/86/three.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-analytics.js"></script>

    <script src="https://jchabin.github.io/VR-ThreeJS-Test/ThreeJS/DeviceOrientationControls.js"></script>
    <script src="https://jchabin.github.io/VR-ThreeJS-Test/ThreeJS/StereoEffect.js"></script>

    <script data-ad-client="ca-pub-8222390470642566" async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

    <title>Online Racing Game!</title>
  </head>

  <body>
    <!-- IMPORTANT:
         Do NOT use display:none here.
         Your script.js uses trackcode.innerText for the map script section; innerText can break when display:none.
         This hides it off-screen but still allows innerText to work reliably. -->
    <div id="trackcode" class="data"
      style="position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; overflow:hidden; white-space:nowrap;"></div>

    <div id="fore">
      <div id="version">v1.1.3.14</div>
      <div class="title" id="title">Online Racing Game!</div>

      <div class="menuitem title">
        Pick a name:<br>
        <input id="name" class="title" ontouchstart="this.focus()" placeholder="Name">
      </div>

      <script>
        var color, updateColor, menu2, host, joinGame, codeCheck;
      </script>

      <div class="menuitem title">
        Choose a color:<br>
        <div id="colorpicker"
          ontouchstart="event.touches[0].buttons = 1; this.onmousemove(event.touches[0])"
          ontouchmove="event.touches[0].buttons = 1; this.onmousemove(event.touches[0])"
          onmousedown="this.onmousemove(event)"
          onmousemove="if(event.buttons == 1){ var x = event.clientX - this.getBoundingClientRect().left; x = Math.min(this.clientWidth, Math.max(0, x)); color = Math.floor(x / this.clientWidth * 360); updateColor(); }">
          <div id="slider"></div>
        </div>
      </div>

      <!-- Start now uses a wrapper so we can optionally re-roll the map before hosting -->
      <div class="menuitem title">
        <div id="start" onclick="startWithMap()">Start!</div>
      </div>

      <!-- FIX: this used to depend on child index, which breaks if you add/remove elements -->
      <div id="settings" onclick="document.getElementById('toolbar').classList.toggle('sel');"></div>

      <div id="toolbar">
        <div class="tools" id="edit"
          onclick="location.href.includes('index.html') ? window.open('editor/index.html') : window.open('editor')"></div>

        <div class="tools" id="cardboard"
          onclick="this.className = this.className == 'tools disabled' ? this.className : this.className == 'tools sel' ? 'tools' : 'tools sel';"></div>

        <div class="tools" id="help"
          onclick="location.href.includes('index.html') ? window.open('help/index.html') : window.open('help')">?</div>
      </div>

      <a id="mywebsitelink" href="https://johnnychabin.com/?projects" target="_blank">
        <img src="https://johnnychabin.com/images/carsprev.webp" style="max-height: 30vmin;">
      </a>

      <div id="warning">
        Hi, it looks like you're playing this game on an unofficial website
        (which probably has sketchy ads and stuff). I would strongly recommend you
        play the game on
        <a href="https://jchabin.github.io/cars" target="_parent">my official website</a>
        instead!
      </div>
    </div>

    <!-- MAP SELECTOR UI (does NOT use class="menuitem" so your animations don’t break) -->
    <div id="mapPicker"
      style="position:fixed; left:12px; bottom:12px; z-index:999999; font-family:'Press Start 2P', monospace; font-size:10px; line-height:1.4; background:rgba(0,0,0,.35); padding:10px 10px; border-radius:10px; user-select:none;">
      <div style="opacity:.9;">MAP: <span id="mapName">...</span></div>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <button id="prevMap" type="button" style="font:inherit; padding:6px 8px; cursor:pointer;">◀</button>
        <button id="randMap" type="button" style="font:inherit; padding:6px 8px; cursor:pointer;">RANDOM</button>
        <button id="nextMap" type="button" style="font:inherit; padding:6px 8px; cursor:pointer;">▶</button>
      </div>
      <label style="display:block; margin-top:8px; opacity:.9; cursor:pointer;">
        <input id="randomOnStart" type="checkbox" style="transform:translateY(1px);">
        Randomize on Start
      </label>
      <div style="margin-top:6px; opacity:.7;">Keys: [ / ] or R</div>
    </div>

    <!-- 5 maps that match your REQUIRED trackcode format:
         WALLS | START/CP | TREES | SIGNS | MAP_SCRIPT -->
    <script>
      const MAPS = [
        {
          name: "Grand Ring",
          data:
            // walls (outer + inner ring)
            "-9,-6/9,-6 9,-6/9,6 9,6/-9,6 -9,6/-9,-6 " +
            "-6,-3/6,-3 6,-3/6,3 6,3/-6,3 -6,3/-6,-3 " +
            // infield box island (doesn't block track)
            "-1,-1/1,-1 1,-1/1,1 1,1/-1,1 -1,1/-1,-1 " +
            "| " +
            // start/finish line + checkpoint line (2 segments)
            "-8,0/-6,0 8,0/6,0 " +
            "| " +
            // trees
            "-8,5 -6,5 -4,5 4,5 6,5 8,5 -8,-5 -6,-5 -4,-5 4,-5 6,-5 8,-5 " +
            "-10,0 10,0 0,7 0,-7 " +
            "| " +
            // signs (x,y,z/deg)
            "-8,1,4/90 8,1,4/-90 -8,1,-4/90 8,1,-4/-90 0,1,6/0 0,1,-6/180 " +
            "| " +
            "window.MAP_NAME='Grand Ring';"
        },
        {
          name: "Octagon Speedway",
          data:
            // outer octagon
            "0,8/6,6 6,6/8,0 8,0/6,-6 6,-6/0,-8 0,-8/-6,-6 -6,-6/-8,0 -8,0/-6,6 -6,6/0,8 " +
            // inner octagon
            "0,5/4,4 4,4/5,0 5,0/4,-4 4,-4/0,-5 0,-5/-4,-4 -4,-4/-5,0 -5,0/-4,4 -4,4/0,5 " +
            "| " +
            "-7,0/-5,0 7,0/5,0 " +
            "| " +
            "-10,0 -9,4 -9,-4 9,4 9,-4 0,10 0,-10 -4,9 4,9 -4,-9 4,-9 " +
            "| " +
            "-6,1,6/45 6,1,6/-45 -6,1,-6/135 6,1,-6/-135 0,1,8/0 0,1,-8/180 " +
            "| " +
            "window.MAP_NAME='Octagon Speedway';"
        },
        {
          name: "Stadium Sprint",
          data:
            // outer long rectangle
            "-10,-4/10,-4 10,-4/10,4 10,4/-10,4 -10,4/-10,-4 " +
            // inner long rectangle
            "-7,-2/7,-2 7,-2/7,2 7,2/-7,2 -7,2/-7,-2 " +
            // chicane islands inside (infield only)
            "-2,-1/2,-1 2,-1/2,1 2,1/-2,1 -2,1/-2,-1 " +
            "| " +
            "-9,0/-7,0 9,0/7,0 " +
            "| " +
            "-11,0 -10,3 -10,-3 10,3 10,-3 0,6 0,-6 -5,5 5,5 -5,-5 5,-5 " +
            "| " +
            "-9,1,3/90 9,1,3/-90 -9,1,-3/90 9,1,-3/-90 0,1,4/0 0,1,-4/180 " +
            "| " +
            "window.MAP_NAME='Stadium Sprint';"
        },
        {
          name: "Triangle Circuit",
          data:
            // outer triangle
            "0,9/8,-5 8,-5/-8,-5 -8,-5/0,9 " +
            // inner triangle
            "0,5/4,-2 4,-2/-4,-2 -4,-2/0,5 " +
            // infield fence
            "-1,0/1,0 0,-1/0,1 " +
            "| " +
            "-6,-3/-4,-3 6,-3/4,-3 " +
            "| " +
            "0,11 10,-6 -10,-6 0,-9 6,6 -6,6 9,0 -9,0 " +
            "| " +
            "-5,1,-2/120 5,1,-2/-120 0,1,7/0 0,1,-7/180 " +
            "| " +
            "window.MAP_NAME='Triangle Circuit';"
        },
        {
          name: "Downtown Loop",
          data:
            // outer rectangle
            "-9,-7/9,-7 9,-7/9,7 9,7/-9,7 -9,7/-9,-7 " +
            // inner offset rectangle (forces different lines)
            "-6,-5/7,-5 7,-5/7,4 7,4/-6,4 -6,4/-6,-5 " +
            // infield alley walls (infield only)
            "-3,1/3,1 3,1/3,2 3,2/-3,2 -3,2/-3,1 " +
            "| " +
            "-8,-1/-6,-1 8,1/6,1 " +
            "| " +
            "-10,7 -10,-7 10,7 10,-7 -2,8 2,8 -2,-8 2,-8 0,0 " +
            "| " +
            "-8,1,6/60 8,1,6/-60 -8,1,-6/120 8,1,-6/-120 0,1,7/0 0,1,-7/180 " +
            "| " +
            "window.MAP_NAME='Downtown Loop';"
        }
      ];

      // --- map apply / UI / hotkeys ---
      let mapIndex = 0;

      function applyMap(i) {
        mapIndex = (i + MAPS.length) % MAPS.length;
        const m = MAPS[mapIndex];
        document.getElementById("trackcode").textContent = m.data;
        document.getElementById("mapName").textContent = m.name;
        try { localStorage.setItem("cars_map_index", String(mapIndex)); } catch(e) {}
        window.SELECTED_MAP_NAME = m.name;
        window.SELECTED_MAP_INDEX = mapIndex;
      }

      function randomMap() {
        let i = Math.floor(Math.random() * MAPS.length);
        if (MAPS.length > 1 && i === mapIndex) i = (i + 1) % MAPS.length;
        applyMap(i);
      }

      // URL override: ?map=0..4
      (function initMapChoice() {
        let picked = null;

        try {
          const url = new URL(location.href);
          const p = url.searchParams.get("map");
          if (p !== null && p !== "") {
            const n = parseInt(p, 10);
            if (!isNaN(n)) picked = n;
          } else {
            const saved = localStorage.getItem("cars_map_index");
            if (saved != null) {
              const n2 = parseInt(saved, 10);
              if (!isNaN(n2)) picked = n2;
            }
          }
        } catch(e) {}

        if (picked == null) picked = Math.floor(Math.random() * MAPS.length);
        applyMap(picked);
      })();

      document.getElementById("prevMap").onclick = () => applyMap(mapIndex - 1);
      document.getElementById("nextMap").onclick = () => applyMap(mapIndex + 1);
      document.getElementById("randMap").onclick = () => randomMap();

      window.addEventListener("keydown", (e) => {
        // Only allow changing maps while still on the main menu (before script.js replaces #fore)
        if (!document.getElementById("fore")) return;
        if (e.key === "[" ) applyMap(mapIndex - 1);
        if (e.key === "]" ) applyMap(mapIndex + 1);
        if (e.key.toLowerCase() === "r") randomMap();
      });

      // Wrapper called by Start button (keeps multiplayer sync: host will store current trackcode into Firebase)
      function startWithMap() {
        const cb = document.getElementById("randomOnStart");
        if (cb && cb.checked) randomMap();
        // menu2 is defined in script.js (loaded below). Clicking Start happens after load, so it exists.
        menu2();
      }
    </script>

    <script src="script.js"></script>
  </body>
</html>
